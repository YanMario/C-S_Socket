//
// Created by yanpan on 2019/1/15.
//

/************************ç½‘ç»œç¼–ç¨‹************************/

//åŸºäºTCP/IPæœåŠ¡å™¨ç«¯ç¼–ç¨‹æµç¨‹
/*
 * 1.åˆ›å»º socket
 * 2.å‘½å socket  bind()å‡½æ•°
 * 3.ç›‘å¬ socket  listen()å‡½æ•°
 * 4.æ¥å—è¿æ¥      accept()å‡½æ•°
 * 5.æ¥æ”¶æ¶ˆæ¯      recv()å‡½æ•°
 * 6.å‘é€æ¶ˆæ¯      send()å‡½æ•°
 * 7.å…³é—­è¿æ¥      close()å‡½æ•°
 */

//ä¸ƒå¤§æ­¥éª¤çš„ç»†èŠ‚
/*
 * 1.åˆ›å»º socket   int socket(int domain, int type, int protocol)
 *   æˆåŠŸæ—¶è¿”å›ä¸€ä¸ªsocket  å¤±è´¥æ—¶è¿”å›-1å¹¶è®¾ç½®errno;
 *   å‚æ•°demain: é€‰æ‹©ä½¿ç”¨å“ªä¸ªåº•å±‚åè®®æ— PF_INET(ipv4) PF_INET6(ipv6)
 *   ç¬¬äºŒä¸ªå‚æ•° type:é€‰æ‹©æœåŠ¡ç±»å‹ SOCK_STREAM(æµæœåŠ¡)   SOCK_UGRAM(æ•°æ®æŠ¥æœåŠ¡)
 *   ç¬¬ä¸‰ä¸ªå‚æ•° protocol: é€‰æ‹©å‰è¾¹ä¸¤ä¸ªåè®®åï¼Œè¿™ä¸ªå‚æ•°è¿˜æ˜¯é€‰æ‹©åè®®çš„å‚æ•°ï¼Œé»˜è®¤å€¼ä¸º0ï¼Œè¡¨ç¤ºä½¿ç”¨é»˜è®¤åè®®
 *
 * 2.å‘½å socket   int bind(int sockfd, const struct sockaddr* my_addr, socklen_t addrlen)
 *   bindå‡½æ•°å°† æœªå‘½åçš„sockfdæ–‡ä»¶æè¿°ç¬¦ä¸my_addræ‰€æŒ‡çš„socketç»‘å®š, addrlenå‚æ•°æ˜¯æŒ‡è¯¥socketåœ°å€çš„é•¿åº¦
 *   bindå‡½æ•°æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥æ—¶è¿”å›-1 å¹¶è®¾ç½®errno -> ä¸¤ä¸ªå¸¸è§çš„error å¦‚ä¸‹ï¼š
 *   EACCES: è¢«ç»‘å®šçš„åœ°å€æ˜¯å—ä¿æŠ¤çš„åœ°å€ï¼Œä»…è¶…çº§ç”¨æˆ·æ‰èƒ½å¤Ÿè®¿é—®
 *   EADDRINUSEï¼šè¢«ç»‘å®šçš„åœ°å€æ­£åœ¨ä½¿ç”¨ä¸­ã€‚ ä¾‹å¦‚ï¼šå°†sockfdç»‘å®šåˆ°ä¸€ä¸ªå¤„äºTIME_WAITçŠ¶æ€ä¸‹çš„socketåœ°å€
 *
 * 3.ç›‘å¬ socket   int listen(int sockfd, int backlog)
 *   å‚æ•°sockfdæ˜¯æŒ‡è¢«ç›‘å¬çš„socketï¼Œ å‚æ•°backlogæ˜¯æŒ‡å†…æ ¸ç›‘å¬é˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦
 *   ç›‘å¬é˜Ÿåˆ—çš„é•¿åº¦å¦‚æœè¶…è¿‡backlogï¼ŒæœåŠ¡å™¨å°†ä¸å—ç†æ–°çš„å®¢æˆ·ç«¯è¿æ¥ï¼Œå®¢æˆ·ç«¯ä¼šæ”¶åˆ°ECONNREFUSEDçš„é”™è¯¯ä¿¡æ¯
 *   linuxå†…æ ¸2.2ç‰ˆæœ¬ä¹‹åè¡¨ç¤ºå¤„äºESTABLISHED(å®Œå…¨è¿æ¥çŠ¶æ€)çš„socketçš„ä¸Šé™ï¼Œbacklogå‚æ•°çš„å…¸å‹å€¼æ˜¯5
 *   listenå‡½æ•°æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥åˆ™è¿”å›-1 å¹¶è®¾ç½®errno
 *
 * 4.æ¥å—è¿æ¥       int accept(int sockfd, struct sockaddr *addr, socklen_t *addrlen)
 *   sockfdæŒ‡çš„æ˜¯ç»è¿‡listenç³»ç»Ÿè°ƒç”¨çš„ç›‘å¬socket  addrå‚æ•°ç”¨æ¥è·å–è¢«æ¥å—è¿æ¥çš„è¿œç«¯socketåœ°å€,addrlenä¸ºå…¶é•¿åº¦
 *   acceptæˆåŠŸæ—¶è¿”å›ä¸€ä¸ªæ–°çš„è¿æ¥socketï¼Œè¯¥socketå”¯ä¸€æ ‡è¯†äº†è¿™ä¸ªè¢«æ¥å—çš„è¿æ¥ï¼Œ
 *   æœåŠ¡å™¨å¯é€šè¿‡è¯»å†™è¯¥socketæ¥ä¸è¢«æ¥å—è¿æ¥å¯¹åº”çš„å®¢æˆ·ç«¯è¿›è¡Œé€šä¿¡ã€‚
 *   acceptå¤±è´¥æ—¶è¿”å›-1å¹¶è®¾ç½®error
 *
 * 5.æ•°æ®çš„è¯»       ssize_t recv(int sockfd, void* buf, siez_t len, int flags)
 *   recvå‡½æ•°è¯»å–å‚æ•°sockfdä¸Šçš„æ•°æ®   å‚æ•°bufå’Œlenåˆ†åˆ«æ˜¯æŒ‡è¯»ç¼“å†²åŒºçš„ä½ç½®å’Œå¤§å°   å‚æ•°flagsä¸ºæ•°æ®æ”¶å‘æä¾›äº†é¢å¤–çš„æ§åˆ¶ï¼Œé€šå¸¸è®¾ç½®ä¸º0
 *   recvå‡½æ•°æˆåŠŸæ—¶è¿”å›å®é™…è¯»å–åˆ°çš„æ•°æ®çš„é•¿åº¦,å®ƒå¯èƒ½å°äºlen,å› æ­¤å¯èƒ½ä¼šå¤šæ¬¡è°ƒç”¨recvã€‚
 *   å½“recvè¿”å›0ï¼Œæ„å‘³ç€é€šä¿¡å¯¹æ–¹å·²ç»å…³é—­äº†è¿æ¥
 *   å¤±è´¥åˆ™è¿”å›-1ï¼Œå¹¶è®¾ç½®errno
 *
 * 6.æ•°æ®çš„å†™       ssize_t send(int sockfd, const void* buf, size_t len, int flags)
 *   sendå‡½æ•°å¾€å‚æ•°sockfdå†™å…¥æ•°æ®   å‚æ•°bufå’Œlenåˆ†åˆ«æ˜¯æŒ‡å†™ç¼“å†²åŒºçš„ä½ç½®å’Œå¤§å°   å‚æ•°flagsä¸ºæ•°æ®æ”¶å‘æä¾›äº†é¢å¤–çš„æ§åˆ¶ï¼Œé€šå¸¸è®¾ç½®ä¸º0
 *   sendæˆåŠŸè¿”å›å®é™…å†™å…¥æ•°æ®çš„é•¿åº¦ï¼Œå¤±è´¥è¿”å›-1å¹¶è®¾ç½®errno
 *
 * 7.å…³é—­è¿æ¥       int close(int fd)
 *   å‚æ•°fdæ˜¯å¾…å…³é—­çš„socket
 *   closeç³»ç»Ÿè°ƒç”¨å¹¶ä¸æ˜¯ç«‹å³å…³é—­ è€Œæ˜¯å°†fdçš„å¼•ç”¨è®¡æ•°ä¸º0æ—¶æ‰çœŸæ­£å…³é—­è¿æ¥
 *   å¤šè¿›ç¨‹ç¨‹åºä¸­ï¼Œä¸€æ¬¡forkç³»ç»Ÿè°ƒç”¨é»˜è®¤çˆ¶è¿›ç¨‹æ‰“å¼€å¾—socketçš„å¼•ç”¨è®¡æ•°åŠ 1ï¼Œæ‰€ä»¥è¦å°†çˆ¶å­è¿›ç¨‹ä¸­çš„socketéƒ½å…³é—­æ‰æ˜¯çœŸæ­£æ–­å¼€è¿æ¥
 *
 *   å¦‚æœæƒ³ç«‹å³ç»ˆæ­¢è¿æ¥ å¯ä»¥ä½¿ç”¨ä¸‹åˆ—çš„å‡½æ•°Â 
 *   int shutdown(int fd,int howto)
 *   howtoå†³å®šäº†å…³é—­çš„è¡Œä¸º
 *   SHUT_RD å…³é—­socketè¯»çš„ä¸€ç«¯,åº”ç”¨ç¨‹åºä¸èƒ½é’ˆå¯¹socketè¿›è¡Œè¯»æ“ä½œ,å¹¶ä¸”è¯¥socketæ¥å—ç¼“å†²åŒºä¸­çš„æ•°æ®éƒ½è¢«ä¸¢å¼ƒ
 *   SHUT_WR å…³é—­socketå†™çš„ä¸€ç«¯,åœ¨å…³é—­ä¹‹å‰å°†socketå‘é€ç¼“å†²åŒºçš„æ•°æ®å…¨éƒ¨å‘é€å‡ºå»,åº”ç”¨ç¨‹åºä¸èƒ½é’ˆå¯¹socketè¿›è¡Œå†™æ“ä½œ,è¯¥æƒ…å†µä¸‹,ç»å¸¸å¤„äºåŠå…³é—­çŠ¶æ€
 *   SHUT_RDWR åŒæ—¶å…³é—­socketä¸Šçš„è¯»ä¸å†™
 *   shutdownå‡½æ•°æˆåŠŸæ—¶è¿”å›0, å¤±è´¥åˆ™è¿”å›-1,å¹¶è®¾ç½®errno
 */

//åŸºäºTCP/IPå®¢æˆ·ç«¯ç¼–ç¨‹æµç¨‹
/*
 * 1.åˆ›å»º socket
 * 2.å‘èµ·è¿æ¥      connect()å‡½æ•°
 * 3.æ¥æ”¶æ¶ˆæ¯      recv()å‡½æ•°
 * 4.å‘é€æ¶ˆæ¯      send()å‡½æ•°
 * 5.å…³é—­è¿æ¥      close()å‡½æ•°
 */

//å®¢æˆ·ç«¯ç¼–ç¨‹çš„å‡½æ•°ç»†èŠ‚ï¼Œ1ã€2ã€4ã€5ã€6ä¸æœåŠ¡å™¨ç«¯ç›¸åŒ
/*
 * 2.å‘èµ·è¿æ¥      int connect(int sockfd, const struct sockaddr *serv_addr, socklen_t addrlen)
 *   å‚æ•°sockfd æ˜¯ç”±ç³»ç»Ÿè°ƒç”¨è¿”å›çš„ä¸€ä¸ªsocket   å‚æ•°serv_addr æ˜¯æœåŠ¡å™¨ç›‘å¬çš„socketåœ°å€,å‚æ•°addrlenæŒ‡è¿™ä¸ªåœ°å€çš„é•¿åº¦
 *   æˆåŠŸæ—¶è¿”å›0 ä¸€æ—¦è¿æ¥æˆåŠŸ sockfdå°±å”¯ä¸€æ ‡è¯†äº†è¿™ä¸ªè¿æ¥,å®¢æˆ·ç«¯å¯é€šè¿‡è¯»å†™è¯¥sockfdæ¥ä¸æœåŠ¡å™¨è¿›è¡Œé€šä¿¡ã€‚
 *   å¤±è´¥æ—¶è¿”å›-1å¹¶è®¾ç½®errno  ->  ECONNREFUSED ç›®æ ‡ç«¯å£ä¸å­˜åœ¨ è¿æ¥è¢«æ‹’ç»
 *                             ETIMEDOUT è¿æ¥è¶…æ—¶
 */

#if 1

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <fcntl.h>
#include <string.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <pthread.h>
#include <sys/select.h>


void main()
{
    int sockfd = socket(PF_INET, SOCK_STREAM, 0);  //åˆ›å»ºå¥—æ¥å­—
    if(-1 == sockfd)
        return;

    struct sockaddr_in ser,cli;     //åœ¨ç»‘å®šå‡½æ•°(bind();)ä¸­éœ€è¦çš„ç»“æ„ä½“ï¼Œç”¨æ¥è®°å½•å®¢æˆ·ç«¯çš„ipåœ°å€å’Œç«¯å£å·
    ser.sin_family = PF_INET;       //åœ°å€æ—ï¼šTcp/Ip
    ser.sin_port = htons(6000);     //å°†å®¢æˆ·ç«¯çš„ç«¯å£å·è½¬åŒ–ä¸ºç½‘ç»œå­—èŠ‚åº
    ser.sin_addr.s_addr = inet_addr("127.0.0.1"); //å°†å®¢æˆ·ç«¯çš„ipåœ°å€è½¬åŒ–ä¸ºç½‘ç»œå­—èŠ‚åº  "127.0.0.1"æ˜¯è¿æ¥æœ¬æœºçš„ipåœ°å€

    int ret = bind(sockfd, (struct sockaddr*)&ser, sizeof(ser));   //å‘½åå¥—æ¥å­—
    if(-1 == ret)
        return;

    int listen_fd = listen(sockfd, 5);
    if(-1 == listen_fd)
        return;
    int len = sizeof(cli);
    //è¿æ¥å¥—æ¥å­—  é€šè¿‡cå®ç°æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯ä¹‹é—´çš„é€šä¿¡
    int c = accept(sockfd, (struct sockaddr*)&cli, &len);
    if(-1 == c)
				return;

    while(1)
    {
        char buff[256] = {0};
        //æ¥æ”¶å®¢æˆ·ç«¯æ¶ˆæ¯
        int n = recv(c, buff, 128, 0);
        if(n <= 0)
        {
            //å…³é—­è¿æ¥
            close(c);
            return;
        }
        printf("buff: %s\n", buff);
        //å‘å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯  "ğŸ‘Œ"ï¼Œæ¥æ”¶æˆåŠŸ
        send(c, "ok", 2, 0);
    }
		close(sockfd);
}

#endif

